---
title: "data_generating_model"
author: "Sigrid Bom"
date: "2026-01-13"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,        # Suppress warnings
  message = FALSE,        # Suppress package loading messages
  echo = TRUE,           # Show R code
  fig.width = 8,         # Set default figure width
  fig.height = 5,        # Set default figure height
  fig.align = 'center',  # Center figures
  out.width = "80%",     # Make figures 80% of text width
  dpi = 300             # Set high resolution for figures
  )
pacman::p_load(tidyverse, cmdstanr, tidyverse, posterior, bayesplot, tidybayes, rstan, brms, pracma, here)
```

## Simulating data based on experimental design of the HRD (note, RRST is a bit different)

Load actual data to compare

```{r}
#df = read_delim("../../cicap_youth/data/pilot/hrd/recordid_13_20250707_1400HRD_final.txt")
df = read_delim("../../cicap_youth/data/pilot/hrd/recordid_14_20250707_1440HRD_final.txt")

df = df %>% mutate(
  choice = ifelse(df$Decision == 'More', 1, 0)
)

df %>% ggplot() +
  aes(Alpha, choice) + 
  geom_point() + 
  labs(
    x = 'delta BPM',
    y = 'probability of answering faster',
    title = 'pilot (messy) data'
  )
```

The participant with record id 13 has a very positive bias towards their heart rate (almost all values of delta bpm (alpha) are above 0).

The participant with record id 14 has a very negative bias towards their heart rate (all values of delta bpm are negative)

```{r}
# wrangle into same form as simulated data will be - for later comparison
emp_data = df %>% mutate(
  subject = 1,
  trial = 1:nrow(df),
  stimulus = Alpha,
  response = ifelse(df$Decision == 'More', 1, 0)
) %>% select(subject, trial, stimulus, response)
```

# 1. Conceptual definition of (very simple) model

We start simple with a logistic (psychometric) function with threshold (alpha) and slope (beta) parameters

$$

p(y = 1 \mid x) = \frac{1}{1 + \exp\!\left[-\beta \left(x - \alpha\right)\right]}

$$
where given p, responses are drawn from a Bernoulli distribution (independently samples each trial with probability p of sampling 1, with probability 1-p of sampling 0.

Below, written as a function in R

```{r psychometric function}
 psychometric_f <- function(x, alpha, beta) {
  1 / (1 + exp(-beta * (x - alpha)))
}
```

# 2. Design of HRDT

```{r}
# study design
n_sub_hrdt <- 60
n_trials_hrdt <- 40
delta_bpm <- rep(seq(-40, 40, 5),n_trials_hrdt) # might need to change range based on what's plausible

```

```{r}
sim_data <- expand.grid(
  subject = factor(1:n_sub_hrdt),
  trial   = 1:n_trials_hrdt
)

sim_data$stimulus <- sample(delta_bpm, nrow(sim_data), replace = TRUE) # sampling with replacement, independent samples
# random trial stimulus (delta_bpm - doesn't not take the adaptive algorithm of the experiment into account)

```

# 3. Generate responses based on set values of alpha and beta

```{r parameter values}
# seed
seed = 1997
set.seed(seed)

# parameters
alpha <- 0     # threshold
beta  <- 2   # slope
```

```{r}
# generate probability of answering 1, faster based on psychometric function
sim_data$p_faster <- psychometric_f(
  x     = sim_data$stimulus,
  alpha = alpha,
  beta  = beta
)

# generate responses
sim_data$response <- rbinom(
  n = nrow(sim_data),
  size = 1, # this is 1, because we are not simulating aggregated data (i.e., 20 repeated trials per stimulus level) - so when set to 1, we effectively draw from a Bernoulli distribution and have independent samples
  prob = sim_data$p_faster
)


```


# 4. Plotting the simulated data

```{r}
# plotting the probabilities of answering 'faster'
sim_data %>%
  ggplot(aes(x = p_faster)) +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 30,
                 colour = "black",
                 fill = "grey80") +
  geom_density(linewidth = 1) +
  labs(
    x = "Probability of answering faster",
    y = "Density"
  ) +
  theme_classic()

```
Not sure this is how we want it to look.

```{r}
# plotting the range of stim level 
sim_data %>%
  ggplot(aes(x = stimulus)) +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 30,
                 colour = "black",
                 fill = "grey80") +
  geom_density(linewidth = 1) +
  labs(
    x = "Probability of answering faster",
    y = "Density"
  ) +
  theme_classic()
```
Makes sense given how the data was sampled (sample with replacement).

```{r}
sim_data %>% 
  filter(subject == 1) %>% 
  ggplot() + 
  aes(stimulus, response) + 
  geom_point() + 
  geom_line(aes(y = p_faster))
```
looks like the perfect participant 


```{r}
# summarising and plotting empirical and simulated data 
emp_summary <- emp_data %>%
  group_by(stimulus) %>%
  summarise(
    p_faster = mean(response),
    n     = n()
  )

sim_summary <- sim_data %>%
  group_by(stimulus) %>%
  summarise(
    p_faster = mean(response),
    n     = n()
  )


ggplot() +
  geom_point(
    data = emp_summary,
    aes(x = stimulus, y = p_faster),
    size = 3
  ) +
  geom_point(
    data = sim_summary,
    aes(x = stimulus, y = p_faster),
    shape = 1,
    size = 3
  ) +
  labs(
    x = "Stimulus intensity",
    y = "Proportion 'yes'",
    title = "Empirical (filled) vs simulated (open) data"
  ) +
  theme_minimal()

```

now, the empirical data is not perfect in this example, but there is slight trend of something that looks like a psychometric function. slight

```{r}
# checking things
range(beta * (sim_data$stimulus - alpha))

tapply(sim_data$p_faster, sim_data$stimulus, mean)

tapply(sim_data$response, sim_data$stimulus, mean)

```

# now for trying different values of alpha and beta

```{r}
# Parameter values
alpha_vals <- c(-20, 0, 20)   # threshold
beta_vals  <- c(0.1, 0.3, 2)    # slope
delta_bpm <- rep(seq(-40, 40, 5),n_trials_hrdt) # check that this is the actual range

# create combinations of different parameter values
sim_grid <- expand.grid(
  alpha = alpha_vals,
  beta  = beta_vals,
  stimulus = delta_bpm
)

# create probabilities using psychometric function
sim_grid <- sim_grid %>%
  mutate(p_faster = psychometric_f(stimulus, alpha, beta))
```

```{r}
ggplot(sim_grid, aes(x = stimulus, y = p_faster)) +
  geom_line(size = 1) +
  facet_grid(alpha ~ beta, labeller = label_both) +
  labs(
    x = "delta BPM",
    y = "Probability of 'faster'",
    title = "Psychometric curves for different alpha and beta values"
  ) +
  theme_minimal(base_size = 14)

```


### Psychometric function but with lapse rate (lambda) - from Jesper's thesis
first the simple model with lapse rate, which according to Jesper, you achieve by multiplying the psychometric function with this term:

$$
\lambda + (1-2*\lambda) * F(x)
$$
where F(x) is one's function.
This means that the simple model with a lape rate would look like this:

$$
p(x|\alpha, \beta, \lambda) = \lambda + (1-2*\lambda) * (\frac{1}{1 + \exp\!\left[-\beta \left(x - \alpha\right)\right]})

$$
which as a function in R looks like this:

```{r}
 psychometric_f_lapse <- function(x, alpha, beta, lambda) {
  lambda + (1-2*lambda)* (1 / (1 + exp(-beta * (x - alpha))))
}
```

now we follow the same steps as before. the data has already been simulated, what we want to change is how we generate the responses based on this new function

```{r}

lambda = 0.01

# generate probability of answering 1, faster based on psychometric function
sim_data_simple_lapse = sim_data %>% 
  select(c(subject, trial, stimulus))

sim_data_simple_lapse$p_faster <- psychometric_f_lapse(
  x     = sim_data_simple_lapse$stimulus,
  alpha = alpha,
  beta  = beta,
  lambda = lambda
)

# generate responses
sim_data_simple_lapse$response <- rbinom(
  n = nrow(sim_data_simple_lapse),
  size = 1, # this is one, because we are not simulating aggregated data (i.e., 20 repeated trials per stimulus level) - so when set to 1, we effectively draw from a Bernoulli distribution and have independent samples
  prob = sim_data_simple_lapse$p_faster
)

```

#plotting the simulated data

```{r}
sim_data_simple_lapse %>% ggplot() +
  aes(x = p_faster) +
  geom_histogram(bins = 30)

# plotting the probabilities of answering 'faster'
sim_data_simple_lapse %>%
  ggplot(aes(x = p_faster)) +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 30,
                 colour = "black",
                 fill = "grey80") +
  geom_density(linewidth = 1) +
  labs(
    x = "Probability of answering faster",
    y = "Density"
  ) +
  theme_classic()
```

```{r}
sim_data_simple_lapse %>% 
  filter(subject == 1) %>% 
  ggplot() + 
  aes(stimulus, response) + 
  geom_point() + 
  geom_line(aes(y = p_faster))

```


# Conceptual definition of a model with lapse rate

$$

p(y = 1 \mid x) = \frac{1}{1 + \exp\!\left[-\beta \left(x - \alpha\right)\right]}

$$

$$

p(x \mid \alpha,\beta, \lambda) = \lambda + (1-2*\lambda)*(0.5+0.5*erf(\frac{x-\alpha}{\beta*\sqrt{2}}))

$$
which can be written in R as follows

```{r}
 probit_regression <- function(x, alpha, beta, lambda) {
  lambda + (1 - 2 * lambda) * (0.5+0.5*erf((x-alpha)/(beta*sqrt(2))))
}
```

we also need the inverse logit function, to transform values from log-odds scale to probability scale (0-1)
```{r}
inv_logit<-function(x){
  y=1/(1+exp(-x))
  return(y)
}
```
```

and then we do the same as before (but with a negative value of lambda based on Jesper's thesis - I don't know why)



```{r}

lambda = -2

# generate probability of answering 1, faster based on psychometric function
sim_data_lapse = sim_data %>% 
  select(c(subject, trial, stimulus))

sim_data_lapse$p_faster <- probit_regression(
  x     = sim_data_lapse$stimulus,
  alpha = alpha,
  beta  = beta,
  lambda = lambda
)

# generate responses
sim_data_lapse$response <- rbinom(
  n = nrow(sim_data_lapse),
  size = 1,
  prob = inv_logit(sim_data_lapse$p_faster)
)
```

```{r}
sim_data_lapse %>% ggplot() +
  aes(x = p_faster) +
  geom_histogram(bins = 30)

# plotting the probabilities of answering 'faster'
sim_data_lapse %>%
  ggplot(aes(x = inv_logit(p_faster))) +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 30,
                 colour = "black",
                 fill = "grey80") +
  geom_density(linewidth = 1) +
  labs(
    x = "Probability of answering faster",
    y = "Density"
  ) +
  theme_classic()
```


```{r}
sim_data_lapse %>% 
  filter(subject == 1) %>% 
  ggplot() + 
  aes(stimulus, response) + 
  geom_point() + 
  geom_line(aes(y = inv_logit(p_faster)))
```



### Parameter recovery - next step

